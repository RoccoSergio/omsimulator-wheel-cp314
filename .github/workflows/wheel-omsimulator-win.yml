name: build-omsimulator-wheel-win

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (runner)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install cibuildwheel + tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel==3.* build delvewheel

      - name: Install OpenModelica (includes OMSimulator DLLs)
        uses: OpenModelica/setup-openmodelica@v1

      - name: Download OMSimulator sdist from PyPI
        run: |
          python -m pip download --no-deps --no-binary :all: OMSimulator==3.0.0.post116 -d sdist

      - name: Extract sdist
        shell: pwsh
        run: |
          $tgz = Get-ChildItem -Path sdist -Filter "omsimulator-3.0.0.post116.tar.gz" | Select-Object -First 1
          tar -xf $tgz.FullName -C sdist
          $dir = Get-ChildItem -Path sdist -Directory | Where-Object { $_.Name -like "omsimulator-3.0.0.post116*" } | Select-Object -First 1
          echo "PKGDIR=$($dir.FullName)" >> $env:GITHUB_ENV

      - name: Build wheel (cp314 win_amd64 only)
        env:
          CIBW_BUILD: "cp314-win_amd64"
          CIBW_SKIP: "cp314t-*"
          CIBW_ENVIRONMENT: "PATH=${{ env.PATH }};C:\\OpenModelica*\\bin"
          CIBW_REPAIR_WHEEL_COMMAND: >
            python -m delvewheel repair -w {dest_dir} {wheel}
        run: |
          python -m cibuildwheel "%PKGDIR%" --output-dir wheelhouse

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: omsimulator-wheels
          path: wheelhouse/*.whl
