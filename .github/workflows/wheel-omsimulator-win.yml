name: build-omsimulator-wheel-win

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Python "di servizio" per scaricare/extract sdist (va bene 3.12)
      - name: Setup Python (bootstrap)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install OpenModelica (optional, provides DLLs/tools)
        uses: OpenModelica/setup-openmodelica@v1

      - name: Add OpenModelica to PATH (optional)
        shell: pwsh
        run: |
          $omHome = $env:OPENMODELICAHOME
          if ($omHome) {
            Add-Content -Path $env:GITHUB_PATH -Value (Join-Path $omHome "bin")
            Write-Host "OPENMODELICAHOME=$omHome"
          } else {
            Write-Host "OPENMODELICAHOME not set (continuing)"
          }

      - name: Download OMSimulator sdist from PyPI
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip download --no-deps --no-binary :all: OMSimulator==3.0.0.post116 -d sdist

      - name: Extract sdist and locate package root
        shell: pwsh
        run: |
          $tgz = Get-ChildItem -Path sdist -Filter "omsimulator-3.0.0.post116.tar.gz" | Select-Object -First 1
          if (-not $tgz) { throw "sdist tar.gz not found" }

          tar -xf $tgz.FullName -C sdist

          $root = Join-Path "sdist" "omsimulator-3.0.0.post116"
          if (-not (Test-Path $root)) {
            Write-Host "Top-level dirs under sdist:"
            Get-ChildItem -Path sdist -Directory | ForEach-Object { Write-Host " - $($_.FullName)" }
            throw "Expected extracted dir not found: $root"
          }

          # Sanity check: we expect packaging files at root
          if (-not (Test-Path (Join-Path $root "pyproject.toml")) -and
              -not (Test-Path (Join-Path $root "setup.cfg")) -and
              -not (Test-Path (Join-Path $root "setup.py"))) {
            throw "Package root does not contain pyproject/setup.cfg/setup.py: $root"
          }

          "PKGDIR=$root" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "PKGDIR=$root"

      # Ora passiamo davvero a Python 3.14.2 per costruire la wheel
      - name: Setup Python 3.14.2 (builder)
        uses: actions/setup-python@v5
        with:
          python-version: "3.14.2"

      - name: Build wheel (pure python)
        shell: pwsh
        run: |
          python --version
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build "$env:PKGDIR" --wheel -o wheelhouse

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: omsimulator-wheels
          path: wheelhouse/*.whl
